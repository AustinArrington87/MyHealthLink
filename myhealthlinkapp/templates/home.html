{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-bold mb-8">Welcome, Michelle G</h1>
    
    <div class="bg-white shadow-md rounded-lg p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Analyze Health Record</h2>
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center" id="dropZone">
            <input type="file" id="fileInput" multiple class="hidden" accept=".pdf,.png,.jpg,.jpeg">
            <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                + Add Document
            </button>
            <p class="text-gray-500 mt-2">or drag and drop files here</p>
        </div>
    </div>

    <div id="analysisResult" class="bg-white shadow-md rounded-lg p-6 mb-6 hidden">
        <h2 class="text-xl font-semibold mb-4">Analysis Results</h2>
        <div class="space-y-4">
            <div>
                <h3 class="font-medium mb-2">Synopsis</h3>
                <p id="synopsis" class="text-gray-700 whitespace-pre-line"></p>
            </div>
            <div>
                <h3 class="font-medium mb-2">Insights and Anomalies</h3>
                <p id="insights-anomalies" class="text-gray-700 whitespace-pre-line"></p>
            </div>
            <div id="citationsSection" class="hidden">
                <h3 class="font-medium mb-2">Citations</h3>
                <p id="citations" class="text-gray-700 whitespace-pre-line"></p>
            </div>
            <div class="flex space-x-4 mt-6">
                <button class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="saveAnalysis()">
                    Save
                </button>
                <button class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600" onclick="shareAnalysis()">
                    Share
                </button>
            </div>
        </div>
    </div>

    <div class="bg-white shadow-md rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">My Analysis History</h2>
        <div id="analysisHistory" class="space-y-4">
            <!-- Analysis history items will be populated here -->
        </div>
    </div>
</div>

<script>
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-blue-500');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
    });

    function handleFiles(files) {
        const formData = new FormData();
        for (const file of files) {
            formData.append('files[]', file);
        }

        // Show loading state
        dropZone.innerHTML = '<p class="text-gray-500">Analyzing files...</p>';

        fetch('/upload', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            resetUploadArea();
            if (data && data.success) {
                showAnalysisResult(data);
            } else {
                throw new Error(data.error || 'Analysis failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resetUploadArea();
            alert('An error occurred while analyzing the files. Please try again.');
        });
    }

    function showAnalysisResult(data) {
        const resultDiv = document.getElementById('analysisResult');
        resultDiv.classList.remove('hidden');
        
        try {
            if (data && data.result) {
                // Show synopsis
                document.getElementById('synopsis').textContent = 
                    data.result.synopsis || 'No synopsis available';
                
                // Show insights and anomalies
                const insightsAnomalies = data.result.insights_anomalies;
                if (insightsAnomalies && insightsAnomalies !== 'No findings to report.') {
                    // Split on line breaks and handle numbering
                    const lines = insightsAnomalies
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0)
                        .join('\n');
                    
                    document.getElementById('insights-anomalies').textContent = lines;
                } else {
                    document.getElementById('insights-anomalies').textContent = 
                        'No significant findings to report.';
                }
                
                // Handle citations
                const citationsSection = document.getElementById('citationsSection');
                const citations = data.result.citations;
                
                if (citations && citations !== 'No Citations available.') {
                    document.getElementById('citations').textContent = citations;
                    citationsSection.classList.remove('hidden');
                } else {
                    citationsSection.classList.add('hidden');
                }
            } else {
                throw new Error('Invalid data format');
            }
        } catch (error) {
            console.error('Error processing results:', error);
            document.getElementById('synopsis').textContent = 'Error processing analysis';
            document.getElementById('insights-anomalies').textContent = 'Error processing analysis';
            citationsSection.classList.add('hidden');
        }
    }

    function resetUploadArea() {
        dropZone.innerHTML = `
            <input type="file" id="fileInput" multiple class="hidden" accept=".pdf,.png,.jpg,.jpeg">
            <button onclick="document.getElementById('fileInput').click()" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                + Add Document
            </button>
            <p class="text-gray-500 mt-2">or drag and drop files here</p>
        `;
        
        // Reattach event listener to new file input
        const newFileInput = document.getElementById('fileInput');
        newFileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    }

    function saveAnalysis() {
        alert('Analysis saved successfully!');
    }

    function shareAnalysis() {
        alert('Share feature coming soon!');
    }
</script>
{% endblock %}
